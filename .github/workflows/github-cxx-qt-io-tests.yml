# SPDX-FileCopyrightText: 2022 Klar√§lvdalens Datakonsult AB, a KDAB Group company <info@kdab.com>
# SPDX-FileContributor: Andrew Hayzen <andrew.hayzen@kdab.com>
# SPDX-FileContributor: Be <be.0@gmx.com>\
# SPDX-FileContributor: Joshua Booth <joshua.n.booth@gmail.com>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: cxx-qt-io tests
on:
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name || github.run_id }}
  cancel-in-progress: true
jobs:
  clang_format:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - run: pip install --user --break-system-packages clang-format==18.1.8
      - run: shopt -s globstar && clang-format --dry-run -Werror include/**/*.h src/**/*.cpp

  rust_format_check:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - run: rustup default nightly
      - run: rustup component add rustfmt
      - run: cargo fmt --all --check --verbose

  shellcheck:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get install -y shellcheck
      - run: shopt -s globstar && shellcheck scripts/*.sh src/**/*.sh

  build:
    # Run after pre checks
    needs: [clang_format, rust_format_check, shellcheck]
    strategy:
      matrix:
        include:
          - name: Qt 6.10
            os: ubuntu-24.04
            aqt_version: 6.10.1
            aqt_arch: linux_gcc_64

          - name: Qt 6.9
            os: ubuntu-24.04
            aqt_version: 6.9.0
            aqt_arch: linux_gcc_64

          - name: Qt 6.8
            os: ubuntu-24.04
            aqt_version: 6.8.0
            aqt_arch: linux_gcc_64

          - name: Qt 6.7
            os: ubuntu-24.04
            aqt_version: 6.7.0
            aqt_arch: linux_gcc_64

          - name: Qt 6.6
            os: ubuntu-22.04
            aqt_version: 6.6.0
            aqt_arch: gcc_64

          - name: Qt 6.5
            os: ubuntu-22.04
            aqt_version: 6.5.0
            aqt_arch: gcc_64

          - name: Qt 6.4
            os: ubuntu-22.04
            aqt_version: 6.4.0
            aqt_arch: gcc_64

          - name: Qt 6.3
            os: ubuntu-22.04
            aqt_version: 6.3.0
            aqt_arch: gcc_64

          - name: Qt 6.2
            os: ubuntu-22.04
            aqt_version: 6.2.0
            aqt_arch: gcc_64

          - name: Qt 6.1
            os: ubuntu-22.04
            aqt_version: 6.1.0
            aqt_arch: gcc_64

    runs-on: ${{ matrix.os }}
    name: Build - ${{ matrix.name }}

    steps:
      - name: Clone Git repository
        uses: actions/checkout@v6
      - name: Install Rust toolchain
        run: |
          rustup default stable
          rustup component add clippy

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.aqt_version }}
          host: linux
          target: desktop
          arch: ${{ matrix.aqt_arch }}
          tools: tools_cmake
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Build package
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build documentation
        run: cargo doc --release --all-features

  test:
    # Run after pre checks
    needs: [clang_format, rust_format_check, shellcheck]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu 24.04 (gcc)
            os: ubuntu-24.04
            aqt_version: 6.10.1
            aqt_arch: linux_gcc_64
            aqt_host: linux
            cores: 4
            build_type: Release

          - name: macOS 15 (clang)
            os: macos-15
            aqt_version: 6.10.1
            aqt_arch: clang_64
            aqt_host: mac
            dyld_framework_path: /Users/runner/work/cxx-qt/Qt/6.10.1/macos/lib
            macosx_deployment_target: 13.0
            cores: 3
            cc: clang
            cxx: clang++
            build_type: Release

          - name: Windows 2022 (MSVC2019)
            os: windows-2022
            aqt_version: 6.7.3
            aqt_arch: win64_msvc2019_64
            aqt_host: windows
            cores: 4
            cc: cl
            cxx: cl
            build_type: Release

          - name: Windows 2022 (MSVC2022) Debug
            os: windows-2022
            aqt_version: 6.10.1
            aqt_arch: win64_msvc2022_64
            aqt_host: windows
            cores: 4
            cc: cl
            cxx: cl
            build_type: Debug

    runs-on: ${{ matrix.os }}
    name: Test - ${{ matrix.name }}
    env:
      MACOSX_DEPLOYMENT_TARGET: ${{ matrix.macosx_deployment_target }}
      CMAKE_BUILD_PARALLEL_LEVEL: ${{ matrix.cores }}

    steps:
      - name: Clone Git repository
        uses: actions/checkout@v6
      - name: Install Rust toolchain
        run: |
          rustup default stable
          rustup component add clippy

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.aqt_version }}
          host: ${{ matrix.aqt_host }}
          target: desktop
          arch: ${{ matrix.aqt_arch }}
          tools: tools_cmake
          cache: true

      - name: "[Ubuntu] Install dependencies"
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config valgrind

      - name: "[Ubuntu] Add Qt6 tools to PATH"
        if: runner.os == 'Linux'
        run: echo "PATH=/usr/lib/qt6/bin:${PATH}" >> "${GITHUB_ENV}"

      - name: "[macOS] Install dependencies"
        if: runner.os == 'macOS'
        run: brew install automake autoconf-archive

      - name: Configure
        run: cmake -D CMAKE_BUILD_TYPE=${{ matrix.build_type }} -S . -B build
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Test
        run: ctest -C ${{ matrix.build_type }} -T test --output-on-failure
        working-directory: ./build
        env:
          QT_SELECT: qt6
          DYLD_FRAMEWORK_PATH: ${{ matrix.dyld_framework_path }}
